# 데이터 시각화
# 데이터--시각화 / 정보--디자인 / 지식--매핑 / 지혜--?

# 삼찰 :: 관찰, 성찰, 통찰

# 통찰 과정의 시각화 :: 탐색, 분석, 활용

# 탐색(패턴파악)

# 분석(그래프 분석)
# 분석은 탐색을 통해 찾아낸 관계들을 보다 구체적으로 살펴보면서 관계의 형탤를 명확하게 규명하고,
# 그 형태가 지니는 의미를 찾아내는 과정임. 분석에서 가장 중요한 사항은 분석의 방향성아니 검증해야 할 명제, 
# 또는 찾아내야 할 모델링(함수)이나 지표의 개요가 명확해야 한다는 것
# 이 방향성이 처음부터 주어져 있지 않다면, 탐색과정에서 찾아내야 함. 방향성이 없는 상황에서 분석을 통해 도출된 
# 의미는 대부분 큰 가치를 갖기 어려우며, 활용하는 데에도 무리가 따름

# 활용(인포그래픽)
# 결국 활용은 개인 영역과 사회 체계 안에서 다른 사람들과 상호작용하는 영역 모두를 포괄

# 어떤 순서와 형태로 상품을 보여주는가가 매출에 대한 핵심 통찰

# 탐색(1단계)
# 1. 사용 가능한 데이터 확인
# 데이터 명세화 :: 차원과 측정값
# 데이터 구성 원리 1 :: 이벤트 기록으로서 접근
# 데이터 구성 원리 2 :: 객체지향 관점에서의 접근
# 2. 연결 고리의 확인
# 가. 공통 요소 찾기
# 나. 공통 요소로 변환하기(시간데이터 변환, 공간데이터 변환, 분류형 데이터 변환)
# 현실 세계의 거의 모든 데이터는 앞서 설명한 데이터 구성 원리에 의해 시간과 공간 관점의 
# 연결고리를 기본으로 갖고 있음을 명심해야 함. 이 부분을 무조건 보완해 활용할수 있도록 준비
# 다. 탐색 범위 설정
# 3. 관계의 탐색
# 가. 이상값 처리
# 나. 차원과 측정값 유형에 따른 관계 파악 시각화
# 다. 잘라보고 달리보기 :: Slicing, Dice
# 라. 내려다보고 올려다보기 :: Drill down, Reverse drill down
# 마. 척도의 측정 :: Sparkline Chart

# 분석(2단계)
# 탐색을 통해 1차적으로 찾아낸 관계들을 좀 더 구체적이고 수치적으로 살펴보면서 의미있는 관계를
# 수치적인 모델이나 특정 값으로 표현해 내는 과정
# 가. 2차 탐색
# 나. 분석 목표에 따른 분석 기법
# 평균에 대한 검정과 추정 :: T 검정
# 비율에 대한 검정과 추정 :: 직접확률계산법, F분포법
# 분할표의 검정 :: 카이제곱검정, Fisher의 직접확률 검정, 맥네마 검정, 잔차분석
# 변수들 간의 상관관계의 강도 추출 :: 상관분석
# 변수들 간의 선형/비선형 인과관계의 형태와 강도 추출 :: 회귀분석, 다중회귀분석, 로지스틱회귀분석, 판별분석
# 어떤 결과에 영향을 미치는 요인의 선별 :: 요인분석, 주성분분석
# 대상들을 여러 기준값들에 따라 분류하고, 다차원 공간에 배치 :: 군집분석, 다차원척도법
# 차원값들의 패턴이 비슷한 측정값과 그렇지 않은 측정값을 분류 :: 대응분석
# 시간의 흐름에 따라 변하는 데이터를 분석할 수 있는 모델 도출 :: 시계열분석
# 핵심성과지표
# 직관적으로 이해되는 계산, 변환, 가공된 수치를 지표로 만들어 제공하는 것이 훨씬 가치 있음

# 활용(3단계)
# 데이터는 현실 세계의 반영이지만, 현실 세계를 하나의 관점으로 잘라낸 단면과 같은 결과물이기 때문에
# 현실의 다양한 여건을 충분히 반영하려면 다양한 각도의 데이터가 필요
# 데이터를 살펴보는 과정에 수시로 데이터의 원천인 실세계를 돌아보면서 반영이 덜 된 부분들이 무엇이지
# 비현실적인 전제가 무엇인지 체크해야 함.
# 어떤 통찰을 추출해 낸 다음에는 그것을 효과적으로 전달할 수 있는 범위와 시각으로 제한해 수용자가 탐색할 수 있게 해야 함

# 인사이트 발전과 확장
# 가. 탑다운, 보텀업
# 나. 2차 잘라보기, 달리보기, 내려다보기, 올려다보기
# 다. 실시간 vs 비실시간
# 라. 지표의 운영
# 마. 추가 데이터에 대한 필요성
# 바. 시각화의 오류
# 사. 사람의 문제 :: 새로운 가치와 통찰은 서로 다른 것들을 연결하는 것에서 태어난다는 것을 주목

# 5_2_1_1 :: 시각화의 정의
# 할 배리언(구글 수석 경제학자) :: 향후 10년간 가장 중요한 능력은 데이터를 얻는 능력, 처리하는 능력, 
# 가치를 뽑아내는 능력, 시각화하는 능력, 전달하는 능력이 될 것
# 공급자 :: 데이터, 정보 / 수용자 :: 정보, 지식
# 데이터 시각화 :: 통계적 그래픽, 주제 지도학
# 정보 시각화 :: 정보 시각화는 데이터 시각화 분야보다 한 단계 더 정보 형태로 가공 과정을 거치며, 분기도
# 수지도, 히트맵 등의 다양한 그래프를 통해 표현됨
# 인포그래픽 :: 정보형 메시지

# 5_2_2_1 :: 정보 디자인 프로세스
# 디자이너, 에디터, 데이터분석가
# 1. 데이터 수집
# 2. 모든 것을 읽기
# 3. 내러티브 찾기
# 4. 문제의 정의
# 5. 계층구조 만들기
# 6. 와이어프레임 그리기
# 7. 포맷 선택하기
# 8. 시각 접근 방법 결정하기
# 9. 정제와 테스트
# 10. 세상에 선보이기

# 5_2_2_2 :: 빅데이터 시각화 프로세스
# 벤 프라이의 시각화 방법론 :: 1. 정보획득 / 2. 분해 / 3. 선별 / 4. 마이닝 / 5.표현
# 6. 정제 / 7. 상호작용
# 정보구조화 / 정보시각화 / 정보시각표현

# 5_2_3 :: 시각화 방법
# 정보구조화 :: 데이터수집탐색 / 데이터분류 / 데이터배열 / 데이터 재배열
# 정보시각화 :: 시간시각화 / 분포시각화 / 관계시각화 / 여러변수 비교 / 공간 시각화
# 정보시각표현 :: 그래픽 7요소 / 그래픽 디자인 기본 원리 / 인터랙션 / 시각정보 디자인 7원칙

# 5_2_3_1 :: 정보구조화
# 데이터 멍잉
# 가. 데이터 수집 및 탐색
# 나. 데이터 분류 :: 구분텍스트, JSON, XML
# 다. 배열 :: LATCH :: Location / Alphabet / Time / Category /Hierarchy

# 5_2_3_2 :: 정보시각화
# 사고의 목적이 인과관계를 이해하는 것이라면 디자인의 목적은 인과관계를 보여주는 것
# 시간 시각화 :: 막대그래프, 누적막대그래프, 점그래프
# 분포 시각화 :: 파이챠트, 도우넛챠트, 트리맵, 누적연속그래프
# 관계 시각화 :: 스캐터 플롯, 버블챠트, 히스토그램
# 비교 시각화 :: 히트맵, 체르노프 페이스, 스타챠트, 평행좌표계, 다차원척도법
# 공간 시각화 :: 지도 맵핑

# 다차원 척도법 :: 그 잰 거리만 가지고 A와 B의 위치를 알아낼 수 있을까 하는 분석에서 시작

# 5_2_3_3 :: 정보시각표현
# 그래픽적으로 디자인을 완성시티는 단계
# 가. 정보표현을 위한 그래픽 7요소
# 1. 위치 / 2. 크기 / 3.모양 / 4.색 / 5. 명도 / 6.기울기 / 7.질감
# 위크모색명기질

# 시각화를 위한 그래픽 디자인 기본 원리
# 1. 타이포그래피(돌기 있는 셰리프, 돌기 없는 산 셰리프)
# 무게, 크기, 스타일, 색채, 간격
# 2. 색상
# 구분표현/ 순서표현 / 비율표현 / 색채사용과 인지
# 3. 그리드
# 하나의 화면을 읽는 방식 / 정보의 역피라미드 / 망 그리드 / 3등분 법칙
# 4. 아이소타이프
# 하나의 기호가 일정 수량을 대표
# 이햬르 결정하는 것은 사물 그 자체가 아니라 우리가 사물과 함께 연상하는 의미나 패턴

# 다. 인터랙션
# 벤 슈나이더만 :: 개요를 제시하는 것이 가장 처음이며, 확대해 선발하는 것이 그 다음이고,
# 필요한 부분만 상술하는 것이 마지막

# 1. 강조하고 디테일을 보여주는 방식
# 2. 사용자가 콘텐츠를 선택하는 방식
# 3. 여러가지 방법으로 데이터 보여주기
# 4. 사용자 지정으로 시각 맵핑 변화
# 5. 사용자의 관점과 의견이 반영되는 형태

# 라. 시각 정보 디자인 7원칙
# 에드워드 터프티
# 1. 시각적 비교를 강화하라
# 2. 인과관계를 제시하라
# 3. 다중변수를 표시하라
# 5. 콘텐츠의 질과 연과성, 진실성을 분명히 하라
# 6. 시간순이 아닌 공간순으로 나열하라
# 7. 정량적 자료의 정량성을 제거하지 마라

# 5_4_1 :: 빅데이터와 시각화 디자인
# 5_4_1_1 :: 빅데이터와 시각화 이슈
# GE Show
# 기업에서 빅데이터 시각화를 통해 제공할 수 있는 것은 크게 내부적인 것과 외부적인 것으로
# 나눌 수 있음. 내부적으로는 방대한 정보를 하나의 인사이트로 도출할 수 있는 시각적 분석도구로 
# 활용하는 것이며 이를 위해 빅데이터를 이용한 정보전달 및 상황 진단 프로세스 개발이 필요
# 외부적으로는 빅데이터를 이용해 도출한 정보를 고객에게 제공하는 것

# 5_4_1_3 :: 빅데이터와 시각화 디자인의 방향
# 전문 빅데이터 분석 능력과 동시에 시각화 능력, IT 기술 위에 서비스로 구현할 수 있는 능력 선호


data("ChickWeight")
head(ChickWeight)
dim(ChickWeight)
colnames(ChickWeight)

# install.packages('tidyverse')
library(tidyverse)

ggplot(ChickWeight, aes(x=Time, y=weight, colour=Diet, group=Chick)) + geom_line()

ggplot(ChickWeight, aes(x=Time, y=weight, colour=Diet)) + geom_point(alpha=.3) + geom_smooth(alpha=.2, size=1)

h <- ggplot(ChickWeight, aes(x=Time, y=weight, colour=Diet))
h + geom_point(alpha=.3)
h + geom_point(alpha=.3) + geom_smooth(alpha=.4, size=3)

ggplot(subset(ChickWeight, Time==21), aes(x=weight, colour=Diet)) + geom_density()

ggplot(subset(ChickWeight, Time==21), aes(x=weight, fill=Diet)) + 
  geom_histogram(colour='black', binwidth = 50) + facet_grid(Diet~.)

ggplot(subset(ChickWeight, Time==21), aes(x=weight, fill=Diet)) + 
  geom_histogram(colour='black', binwidth = 50) + facet_grid(.~Diet)

data(mtcars)
head(mtcars)

p <- qplot(wt, mpg, colour=hp, data=mtcars)
p + coord_cartesian(ylim=c(0,40)) + scale_color_continuous(breaks = c(100, 300))
p + coord_cartesian(ylim=c(0,40)) + scale_color_continuous(breaks = c(100, 300)) + guides(colour='colourbar')

m <- mtcars[1:10, ]
p %+% m
str(mtcars)
mtcars$cyl <- as.factor(mtcars$cyl)
str(mtcars)

c <- ggplot(mtcars, aes(factor(cyl)))
c + geom_bar()
c + geom_bar(fill='red')
c + geom_bar(fill='white', colour='red')
k <- ggplot(mtcars, aes(factor(cyl), fill=factor(vs)))
k + geom_bar()

head(ChickWeight)
ggplot(ChickWeight, aes(x=weight)) + geom_histogram(aes(fill=..count..)) 

data("economics")
head(economics)

b <- ggplot(economics, aes(x=date, y=unemploy))
b + geom_line()
b + geom_line(colour='red', size=3)
b + geom_line(linetype=2)

df <- data.frame(x=rnorm(5000), y=rnorm(5000))
h <- ggplot(df, aes(x, y))
h + geom_point()
h + geom_point(alpha=.5)
h + geom_point(alpha=1/10)

p <- ggplot(mtcars, aes(wt, mpg))
p + geom_point(size=4)
p + geom_point(aes(colour=factor(cyl)), size=4)
p + geom_point(aes(shape=factor(cyl)), size=4)               

library(reshape2)
library(plyr)

rescale01 <- function(x) (x-min(x)) / diff(range(x))

rescale01 <- function(x) {
  (x-min(x)) / diff(range(x)) 
}

rescale01(economics$psavert)

range(economics$psavert)
range(rescale01(economics$psavert))
head(economics)
colwise(rescale01)(economics[, -c(1:2)])
colwise(rescale01)(economics[, -(1:2)])

ec_scaled <- data.frame(
  date=economics$date,
  colwise(rescale01)(economics[, -(1:2)])
)

head(ec_scaled)
str(ec_scaled)
ecm <- melt(ec_scaled, id='date')

unique(ecm$variable)
ecm$variable

f <- ggplot(ecm, aes(date, value))
f + geom_line(aes(linetype=variable, colour = variable), size=.8)

data("diamonds")
head(diamonds)
str(diamonds)

k <- ggplot(diamonds, aes(carat, ..density..)) + geom_histogram(binwidth = .2)
k + facet_grid(.~cut)


w <- ggplot(diamonds, aes(clarity, fill=cut))
w + geom_bar()
w + geom_bar(aes(order=desc(cut)))

str(mtcars)
p <- ggplot(mtcars, aes(wt, mpg))
p + geom_point(aes(size=qsec, colour = cyl))
p + geom_point(aes(size=qsec, colour = cyl)) + geom_hline(yintercept=25, size=2.5)

df2 <- data.frame(x=1:5, y=1:25, z=1:25)
df2
s <- ggplot(df2, aes(x=x, y=y))
s + geom_point()
s + geom_point(aes(shape=z), size=4) + scale_shape_identity()

# geom_pointrange() with lm's "se" option
dmod <- lm(price ~ cut, data=diamonds)
unique(diamonds$cut)
summary(dmod)
plot(dmod)
unique(diamonds$cut)
data.frame(cut=unique(diamonds$cut))
predict(dmod, data.frame(cut=unique(diamonds$cut)), se=T)
predict(dmod, data.frame(cut=unique(diamonds$cut)), se=T)[c('fit', 'se.fit')]

cuts <- data.frame(cut=unique(diamonds$cut), 
           predict(dmod, data.frame(cut=unique(diamonds$cut)), se=T)[c('fit', 'se.fit')])

se <- ggplot(cuts, aes(x=cut, y=fit, ymin=fit-se.fit, ymax=fit + se.fit, colour=cut))
se + geom_pointrange()

# annotate box
p <- ggplot(mtcars, aes(wt, mpg)) + geom_point()
cuts
p + annotate('rect', xmin=2, xmax=3.5, ymin=2, ymax=25, fill='dark grey', alpha=.5)

# geom_smooth() and scale_x_continuous()
p <- qplot(disp, wt, data=mtcars) + geom_smooth()
p + scale_x_continuous(limits=c(325, 500))

# stat_bin2d() and scale_x_continuous()
d <- ggplot(diamonds, aes(carat, price))
d + geom_point()
d + stat_bin2d(bins = 25, colour='grey50') + scale_x_continuous(limits=c(0,2))

# boxplot
qplot(cut, price, data=diamonds, geom='boxplot')
last_plot() + coord_flip()

dim(diamonds)
qplot(cut, data=diamonds, geom='bar')
h <- qplot(carat, data=diamonds, geom='bar')
h
h + coord_flip()
h + coord_flip() + scale_x_reverse()

# multiple axis
time <- seq(7000, 3400, -200)
pop <- c(200, 400, 450, 500, 300, 100, 400, 700, 830, 1200, 400, 350,
         200, 700, 370, 800, 200, 100, 120)
length(pop)
grp <- c(2,5, 8, 3, 2, 2, 4, 7, 9, 4, 4, 2, 2, 7, 5, 12, 5, 4, 4)
length(grp)
med <- c(1.2, 1.3, 1.2, 0.9, 2.1, 1.4, 2.9, 3.4, 2.1, 1.1, 1.2, 1.5, 1.2, 0.9, 
         0.5, 3.3, 2.2, 1.1, 1.2)
length(med)
par(mar=c(5, 12, 4, 4) + .1)

plot(time, pop, axes=F, ylim=c(0,max(pop)), xlab='', ylab='', type='l', col='black', main='', xlim=c(7000, 3400))
points(time, pop, pch=20, col='black')
axis(2, ylim=c(0,max(pop)), col='black', lwd=2)
mtext(2, text='Population' , line=2)

par(new=T)
plot(time, med, axes=F, ylim=c(0, max(med)), xalb='', ylab='', 
     type='l', lty=2, main='', xlim=c(7000, 3400), lwd=2)
axis(2, ylim=c(0,max(med)), lwd=2, line=3.5)
points(time, med, pch=20)
mtext(2, text='Median Group Size', line=5.5)

par(new=T)
plot(time, grp, axes=F, ylim = c(0,max(grp)), xlab='', ylab='', type='l', 
     lty=3, main='', xlim=c(7000, 3400), lwd=2)
axis(2, ylim=c(0,max(grp)), lwd=2, line=7)
points(time, grp, pch=20)
mtext(2, text='Number of Groups', line=9)

axis(1, pretty(range(time), 10))
mtext('cal BP', side=1, col='black', line=2)

legend(x=7000, y=12, legend=c('Population', 'Median Group Size', 
                              'Number of Groups'), lty=c(1,2,3))


# Spatial Analysis
# install.packages('googleVis')
library(googleVis)

data(Fruits)
head(Fruits)

M1 <- gvisMotionChart(Fruits, idvar='Fruit', timevar='Year')
plot(M1) # not showing

data("Exports")
head(Exports)
G1 <-gvisGeoChart(Exports, locationvar = 'Country', colorvar = 'Profit')
plot(G1)
G2 <- gvisGeoChart(Exports,'Country', 'Profit', options=list(region='150'))
plot(G2)

require(datasets)
states <- data.frame(state.name, state.x77)
head(states)
G3 <- gvisGeoChart(states, 'state.name', 'Illiteracy', 
                   options = list(region='US', displayMode='regions', 
                                  resolution='metros', width=1000, height=400))
plot(G3)

data("CityPopularity")
head(CityPopularity)

G4 <- gvisGeoChart(CityPopularity, locationvar = 'City', colorvar = 'Popularity', 
                   options=list(region='US', height=350, displayMode='markers', 
                                colorAxis="{values:[200,400,600,800], colors:[\'red', \'pink', \'orange', \'green']}"))
plot(G4)

data(Andrew)
head(Andrew)
G5 <- gvisGeoChart(Andrew, "LatLong", colorvar='Speed_kt', options=list(region="US"))
plot(G5)

G6 <- gvisGeoChart(Andrew, "LatLong", sizevar='Speed_kt', colorvar = 'Pressure_mb', 
                   options=list(region="US"))
plot(G6)

# Create lat:long values and plot a map of Oceania
# Set background color to light-blue

require(stats)
data("quakes")
head(quakes)
quakes$latlong <- paste(quakes$lat, quakes$long, sep=':')
head(quakes$latlong)

G7 <- gvisGeoChart(quakes, 'latlong', colorvar = 'depth', sizevar = 'mag', 
                   options=list(displayMode='Markers', 
                                region='009', 
                                colorAxis="{colors:['red', 'grey']}",
                                backgroundColor='lightblue'))
plot(G7)

# install.packages("XML")
library(XML)
url <- 'https://en.wikipedia.org/wiki/List_of_countries_by_credit_rating'
x <- readHTMLTable(readLines(url), which=3)
str(x)
colnames(x)
head(x)

as.character(unname(unlist(x[1, ]))) # 첫 번째 열의 문자열들을 하나의 벡터로 가져오기
colnames(x) <- as.character(unname(unlist(x[1, ])))
head(x)
x <- x[-1, ]
head(x)
rownames(x) <- NULL # re-indexing the dataframe
dim(x)

levels(x$Rating)
levels(x$Rating) <- substring(levels(x$Rating), 4, nchar(levels(x$Rating)))
x$Ranking <- x$Rating
x$Rating <- paste(x$`Country/Region`, x$Rating, sep=':')

head(x)
G8 <- gvisGeoChart(x, 'Country/Region', 'Ranking', hovervar='Rating', 
                   options=list(gvis.editor='S&P', 
                                colorAxis="{colors:['#91BFDB', '#FC8D59']}"))
plot(G8)

# https://earthquake.usgs.gov/earthquakes/feed/v1.0/csv.php
# 상기 사이트에서 data download
library(XML)
eq <- read.csv('./data/2.5_week.csv')
head(eq)
eq$loc <- paste(eq$latitude, eq$longitude, sep=':')

G9 <- gvisGeoChart(eq, 'loc', 'depth', 'mag', 
                   options=list(displayMode="Markers", 
                                colorAxis="{colors:['purple', 'red', 'orange', 'grey']}", 
                                backgroundColor="lightblue"), chartid = "EQ")
plot(G9)


